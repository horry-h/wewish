<!--pages/index/index.wxml-->
<view class="home-container">
  <!-- çŠ¶æ€æ å ä½ -->
  <view class="status-bar" style="height: {{statusBarHeight}}px;"></view>

  <!-- é¡¶éƒ¨åŒºåŸŸ -->
  <view class="top-area">
    <!-- å·¦ä¾§æ ‡é¢˜ -->
    <view class="header">
      <view class="title gradient-text">å½“ä¸‹æœ‰è§£</view>
      <view class="subtitle">Answer Book</view>
    </view>
  </view>

  <!-- æ¯æ—¥ä¸€ç­¾å…¥å£ (æ²»æ„ˆæ¨ªå¹…å¡ç‰‡) -->
  <view class="daily-fortune-entry {{hasOpenedFortune ? 'opened' : ''}}" bindtap="onDailyCardTap">
    <view class="fortune-card-bg"></view>
    <view class="fortune-content">
      <view class="fortune-left">
        <view class="qiantong-wrapper">
          <image class="qiantong-icon {{hasOpenedFortune ? 'static' : ''}}" src="../../assets/img/qiantong.jpg" mode="aspectFit" />
          <view class="glow-dot" wx:if="{{!hasOpenedFortune}}"></view>
        </view>
        <view class="fortune-text">
          <view class="fortune-title">{{hasOpenedFortune ? 'ä»Šæ—¥ç¼˜åˆ† Â· ç­¾æ–‡å·²ç°' : 'ä»Šæ—¥ç¼˜åˆ† Â· æ¯æ—¥ä¸€ç­¾'}}</view>
          <view class="fortune-subtitle">{{hasOpenedFortune ? 'ç‚¹å‡»å†æ¬¡æŸ¥çœ‹å±äºä½ çš„ä»Šæ—¥å¯ç¤º' : 'æ‘‡åŠ¨çµæ„Ÿï¼Œå¼€å¯å±äºä½ çš„ä»Šæ—¥å¯ç¤º'}}</view>
        </view>
      </view>
      <view class="fortune-right">
        <view class="open-btn">{{hasOpenedFortune ? 'æŸ¥çœ‹' : 'å¼€å¯'}}</view>
        <text class="arrow-icon">></text>
      </view>
    </view>
  </view>

  <!-- é—®é¢˜åˆ†ç±»åŒº(ç´§å‡‘æ¨ªå‘) -->
  <view class="category-section">
    <view class="category-hint">è¯·é€‰æ‹©é—®é¢˜ç±»å‹</view>
    <view class="category-list-compact">
      <view 
        class="category-chip {{selectedCategory === item.key ? 'active' : ''}}"
        wx:for="{{categories}}"
        wx:key="key"
        bindtap="onCategoryTap"
        data-key="{{item.key}}"
      >
        <text class="chip-icon">{{item.icon}}</text>
        <text class="chip-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- å¿ƒå£°è¾“å…¥åŒº -->
  <view class="input-section">
    <textarea 
      class="heart-input"
      placeholder="è¯´å‡ºä½ çš„å¿ƒå£°..."
      placeholder-class="input-placeholder"
      maxlength="100"
      value="{{userThought}}"
      bindinput="onInputChange"
    />
    <view class="input-counter">{{userThought.length}}/100</view>
    <!-- é‡ç½®æŒ‰é’®(å±…å³æ”¾ç½®) -->
    <view 
      class="reset-btn {{selectedCategory || userThought ? '' : 'disabled'}}"
      bindtap="onResetTap"
    >
      <text class="reset-icon">â†»</text>
      <text class="reset-text">é‡ç½®</text>
    </view>
  </view>

  <!-- æ ¸å¿ƒäº¤äº’æŒ‰é’® -->
  <view class="action-section">
    <view 
      class="main-button {{isBreathing ? 'breathing' : ''}} {{isPressing ? 'pressing' : ''}}"
      bindtouchstart="onTouchStart"
      bindtouchend="onTouchEnd"
      bindtouchcancel="onTouchCancel"
    >
      <!-- ç¿»ä¹¦æ•ˆæœå±‚ -->
      <view class="book-pages" wx:if="{{isPressing}}">
        <view 
          class="book-page page-{{index}} {{currentPage === index ? 'active' : ''}}"
          wx:for="{{visiblePages}}"
          wx:key="index"
        ></view>
      </view>

      <!-- æŒ‰é’®å†…å®¹ -->
      <view class="button-content">
        <view class="crystal-icon">ğŸ”®</view>
        <view class="button-text-top">é—­ç›®é»˜å¿µ</view>
        <view class="button-text-bottom" wx:if="{{!isPressing}}">é•¿æŒ‰å¯»å£°</view>
        <view class="zen-quote" wx:if="{{isPressing}}">{{currentZenQuote}}</view>
      </view>
      <view class="ripple"></view>
    </view>
  </view>

  <!-- åº•éƒ¨æ–‡æ¡ˆ -->
  <view class="footer-text">å†…å¿ƒå·²æœ‰ç­”æ¡ˆ,åªéœ€è†å¬</view>

  <!-- ç»“æœå¡ç‰‡å¼¹çª— -->
  <view class="result-modal" wx:if="{{showResultCard}}">
    <view class="result-card">
      <!-- é¡¶éƒ¨æ“ä½œæ  -->
      <view class="card-top-bar">
        <view class="card-back-btn" bindtap="onCloseResultCard">
          <text class="icon">â†</text>
          <text>{{isSharedView ? 'å…³é—­' : 'è¿”å›'}}</text>
        </view>
      </view>

      <!-- åˆ†äº«æ¨¡å¼æç¤º -->
      <view class="shared-hint-card" wx:if="{{isSharedView}}">
        <view class="shared-icon">ğŸ</view>
        <view class="shared-text">å¥½å‹åˆ†äº«äº†Taçš„ç­”æ¡ˆ</view>
      </view>

      <!-- è£…é¥°æ˜Ÿæ˜Ÿ -->
      <view class="card-star card-star-1">ğŸŒŸ</view>
      <view class="card-star card-star-2">âœ¨</view>

      <!-- æ ¸å¿ƒç­”æ¡ˆåŒº -->
      <view class="card-answer-section">
        <view class="card-answer">
          <view class="card-answer-text gradient-text">ã€Œ {{resultAnswer}} ã€</view>
        </view>
      </view>

      <!-- åˆ†éš”çº¿ -->
      <view class="card-divider">
        <view class="card-divider-line"></view>
      </view>

      <!-- å¿ƒä¸­æ‰€å¿µ -->
      <view class="card-thought-section" wx:if="{{userThought}}">
        <view class="card-thought-label">{{isSharedView ? 'Taçš„å¿ƒå£°' : 'å¿ƒä¸­æ‰€å¿µ'}}</view>
        <view class="card-thought-content">{{userThought}}</view>
      </view>

      <!-- AIè§£è¯»åŒº -->
      <view class="card-analysis-section">
        <view class="card-analysis-header" bindtap="onAnalysisToggle">
          <view class="card-analysis-icon">{{analysisExpanded ? 'ğŸ”¥' : 'ğŸ’¬'}}</view>
          <view class="card-analysis-title">ä¹¦çµè§£è¯»</view>
          <view class="card-analysis-arrow">{{analysisExpanded ? 'â–²' : 'â–¼'}}</view>
        </view>

        <view class="card-analysis-content {{analysisExpanded ? 'expanded' : ''}}">
          <view class="card-analysis-text">{{displayedAnalysis}}</view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’®ç»„ -->
      <view class="card-action-buttons" wx:if="{{!isSharedView}}">
        <view class="card-action-btn card-btn-secondary" bindtap="onAskAgain">
          <text>å†é—®ä¸€æ¬¡</text>
        </view>
        <view class="card-action-btn card-btn-primary" bindtap="onGenerateCard">
          <text>ç”Ÿæˆå¡ç‰‡</text>
        </view>
      </view>

      <!-- åˆ†äº«æ¨¡å¼ï¼šç‰¹æ®Šå¼•å¯¼æŒ‰é’® -->
      <view class="card-action-buttons" wx:if="{{isSharedView}}">
        <view class="card-action-btn card-btn-primary try-my-answer" bindtap="onTryMyAnswer">
          <text class="btn-icon">âœ¨</text>
          <text>æŠ½æˆ‘çš„ç­”æ¡ˆ</text>
        </view>
      </view>

      <!-- æ—¶é—´æˆ³ -->
      <view class="card-timestamp">è®°å½•äº {{resultTimestamp}}</view>
    </view>
  </view>

  <!-- ç¦»å±Canvasï¼ˆç”¨äºç”Ÿæˆæµ·æŠ¥ï¼‰ -->
  <canvas 
    type="2d" 
    id="posterCanvas" 
    style="position: fixed; left: -9999px; top: -9999px; width: 750px; height: 1000px;"
  ></canvas>

  <!-- æµ·æŠ¥é¢„è§ˆå¼¹çª— -->
  <view class="poster-modal" wx:if="{{showPosterModal}}">
    <view class="poster-mask" bindtap="onClosePosterModal"></view>
    <view class="poster-content">
      <view class="poster-header">
        <text class="poster-title">{{isSharedView ? 'å¥½å‹åˆ†äº«çš„ç­”æ¡ˆ' : 'é•¿æŒ‰ä¿å­˜å›¾ç‰‡'}}</text>
        <view class="poster-header-right">
          <view 
            class="poster-refresh-btn {{isRefreshingBg ? 'refreshing' : ''}}" 
            bindtap="onRefreshBackground"
          >
            <text class="refresh-icon">ğŸ”„</text>
            <text class="refresh-text">æ¢èƒŒæ™¯</text>
          </view>
          <text class="poster-close" bindtap="onClosePosterModal">âœ•</text>
        </view>
      </view>
      
      <image 
        class="poster-image" 
        src="{{posterImagePath}}" 
        mode="widthFix"
        show-menu-by-longpress
      />
      
      <!-- å±•ç¤ºé—®é¢˜å¼€å…³ï¼ˆä»…éåˆ†äº«æ¨¡å¼ï¼‰ -->
      <view class="poster-option" wx:if="{{userThought && !isSharedView}}">
        <view class="poster-option-label">
          <text class="option-icon">ğŸ’­</text>
          <text>å±•ç¤ºæˆ‘çš„é—®é¢˜</text>
        </view>
        <switch 
          class="poster-switch" 
          checked="{{showQuestion}}" 
          bindchange="onToggleShowQuestion"
          color="#ffffff"
        />
      </view>
      
      <!-- åˆ†äº«æ¨¡å¼ï¼šå¼•å¯¼æŒ‰é’® -->
      <view class="poster-actions" wx:if="{{isSharedView}}">
        <button class="poster-btn poster-btn-primary" bindtap="onTryMyAnswer">
          <text class="btn-icon">âœ¨</text>
          <text>é—®æˆ‘çš„é—®é¢˜</text>
        </button>
        <button class="poster-btn poster-btn-save" bindtap="savePoster">
          ä¿å­˜å›¾ç‰‡
        </button>
      </view>
      
      <!-- æ­£å¸¸æ¨¡å¼ï¼šä¿å­˜å’Œåˆ†äº« -->
      <view class="poster-actions" wx:else>
        <button class="poster-btn poster-btn-save" bindtap="savePoster">
          ä¿å­˜åˆ°ç›¸å†Œ
        </button>
        <button 
          class="poster-btn poster-btn-share" 
          open-type="share"
        >
          åˆ†äº«
        </button>
      </view>
    </view>
  </view>
</view>
