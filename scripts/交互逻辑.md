# 交互逻辑说明 - 核心"长按-松开-弹出"机制

## 一、整体流程图

```
[首页] 
  ↓ (选择问题类型)
  ↓ (长按核心按钮)
[交互页] 
  ↓ (持续长按2-5秒)
  ↓ (松开手指)
[结果页]
  ↓ (点击"再问一次")
  ↓ (返回首页)
```

---

## 二、核心交互详细拆解

### 阶段1:首页待机状态 (Idle State)

#### 视觉表现
- 核心按钮处于"呼吸"状态:
  - scale: 0.95 → 1.0 → 0.95 循环
  - opacity: 0.8 → 1.0 → 0.8
  - 动画周期:2秒,easing: ease-in-out

#### 触发条件
- 用户必须先选择问题类型(情感/事业/学业/财富/通用)
- 若未选择,点击按钮时震动提示+toast:"请先选择问题类型"

#### 状态监听
```typescript
// 伪代码
let selectedCategory = null; // 当前选中的类型
let isLongPressing = false;  // 是否正在长按
let longPressTimer = null;    // 定时器句柄
```

---

### 阶段2:长按开始 (Press Start)

#### 触发事件
用户手指触碰到核心按钮区域,触发 `bindtouchstart` 事件。

#### 立即执行的动作(0ms)
1. **视觉反馈**:
   - 按钮scale缩小至0.9(duration: 100ms)
   - 停止呼吸动画
   - 按钮周围出现脉冲光晕(从内向外扩散,透明度衰减)

2. **震动反馈**:
   ```javascript
   wx.vibrateShort({ type: 'medium' });
   ```

3. **音效启动**:
   - 播放背景白噪音(流水声/风铃声),循环播放
   ```javascript
   const bgAudio = wx.createInnerAudioContext();
   bgAudio.src = '/assets/audio/water-bg.mp3';
   bgAudio.loop = true;
   bgAudio.volume = 0; // 初始音量为0
   bgAudio.play();
   // 渐进增大音量(0 → 0.5,持续1秒)
   ```

4. **页面跳转**:
   ```javascript
   wx.navigateTo({
     url: '/pages/seeking/seeking?category=' + selectedCategory
   });
   ```

#### 100ms后执行
- 交互页完成渲染
- 开始书页翻动动画

---

### 阶段3:长按持续状态 (Pressing State)

#### 进入交互页后的动效

##### 1. 书页翻动动画
- **实现方式**: CSS 3D Transform
- **帧率**: 10帧/秒(每100ms切换一次书页)
- **书页总数**: 30张虚拟书页
- **动画逻辑**:
  ```css
  /* 每个书页的翻动 */
  @keyframes flipPage {
    0% { transform: perspective(1000px) rotateY(0deg); }
    50% { transform: perspective(1000px) rotateY(-90deg); }
    100% { transform: perspective(1000px) rotateY(-180deg); }
  }
  ```
  - 当前书页从0°翻转到-180°(100ms)
  - 同时下一页从180°翻转到0°
  - 层叠顺序(z-index)动态调整

##### 2. 粒子汇聚特效
- **Canvas渲染**: 60个光点粒子
- **运动轨迹**: 
  - 初始位置:屏幕随机边缘
  - 目标位置:屏幕中心
  - 速度:2-5rpx/帧,随机波动
  - 大小:2-6rpx,越靠近中心越大
- **颜色**: 金色(#ffd89b)带透明度渐变

##### 3. 进度条
- **类型**: 假进度条(非真实加载)
- **速度**: 
  - 0-60%: 快速增长(1s)
  - 60-85%: 减速增长(1.5s)
  - 85-99%: 极慢增长(等待用户松手)
- **视觉**: 
  - 流光效果(渐变色块从左向右移动)
  - 高度:8rpx,圆角

##### 4. 持续震动
```javascript
// 每300ms震动一次
setInterval(() => {
  if (isLongPressing) {
    wx.vibrateShort({ type: 'light' });
  }
}, 300);
```

##### 5. 禅语提示
- **文案库**: 4-6条禅意金句
- **切换频率**: 每1.5秒切换一次
- **动画**: 淡入淡出(crossfade)
  ```css
  animation: fadeInOut 1.5s infinite;
  @keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    50% { opacity: 1; }
  }
  ```

#### 最短长按时间限制
- **设定**: 2秒
- **目的**: 营造仪式感,避免误触
- **实现**:
  ```javascript
  let canRelease = false;
  setTimeout(() => {
    canRelease = true;
    // 提示文字从"请保持长按"变为"松开获取答案"
  }, 2000);
  ```

---

### 阶段4:松开触发 (Release Trigger)

#### 触发事件
用户手指离开屏幕,触发 `bindtouchend` 事件。

#### 判断逻辑
```javascript
onTouchEnd() {
  const pressDuration = Date.now() - pressStartTime;
  
  if (pressDuration < 2000) {
    // 长按时间不足,震动提示并保持在当前页
    wx.vibrateShort({ type: 'heavy' });
    wx.showToast({
      title: '请长按至少2秒',
      icon: 'none'
    });
    return;
  }
  
  // 符合条件,触发结果生成
  this.generateResult();
}
```

#### 立即执行的动作(0ms)

1. **停止所有动画**:
   - 书页翻动停止(定格在当前帧)
   - 粒子特效淡出(300ms过渡)
   - 进度条瞬间填满至100%

2. **停止音效**:
   ```javascript
   bgAudio.stop();
   ```

3. **重震反馈**:
   ```javascript
   wx.vibrateShort({ type: 'heavy' });
   ```

4. **播放揭晓音效**:
   ```javascript
   const revealAudio = wx.createInnerAudioContext();
   revealAudio.src = '/assets/audio/reveal.mp3';
   revealAudio.play();
   ```

#### 200ms后执行
- **屏幕闪白效果**: 
  - 全屏白色遮罩,opacity: 0 → 0.8 → 0(总时长300ms)
  - 模拟"灵光一现"的视觉冲击

---

### 阶段5:结果生成与展示 (Result Generation)

#### 答案生成逻辑

##### 1. 随机答案池
根据问题类型,从对应的答案库中随机抽取:

```javascript
const answerPool = {
  情感: [
    '勇敢表达', '保持沉默', '顺其自然', '主动出击', 
    '给彼此空间', '坦诚相待', '暂时观望', '倾听内心'
  ],
  事业: [
    '现在就去做', '再等等', '寻求帮助', '独立完成',
    '调整方向', '坚持初心', '适时放弃', '学习充电'
  ],
  学业: [
    '专注当下', '劳逸结合', '寻找方法', '请教他人',
    '制定计划', '突破瓶颈', '回归基础', '保持耐心'
  ],
  财富: [
    '谨慎投资', '大胆尝试', '守住本金', '分散风险',
    '长期持有', '及时止损', '学习理财', '稳中求进'
  ],
  通用: [
    '是的', '不', '或许', '时机未到',
    '听从直觉', '再想想', '问问身边人', '相信自己'
  ]
};

// 加权随机(某些答案出现概率更高)
function getWeightedAnswer(category) {
  const answers = answerPool[category];
  const weights = [20, 15, 15, 12, 10, 10, 8, 10]; // 权重数组
  // ... 加权随机算法
}
```

##### 2. 答案记录
```javascript
// 存储到本地,用于后续生成分享卡片和历史记录
const result = {
  id: Date.now(),
  category: selectedCategory,
  answer: selectedAnswer,
  timestamp: new Date().toISOString(),
  aiAnalysis: null // 稍后生成
};
wx.setStorageSync('lastResult', result);
```

#### 页面跳转
```javascript
wx.redirectTo({ // 使用redirectTo避免返回到交互页
  url: '/pages/result/result'
});
```

---

### 阶段6:结果页呈现 (Result Presentation)

#### 答案显示动画(顺序执行)

1. **T+0ms**: 页面背景淡入
   - 深色渐变背景 opacity: 0 → 1 (300ms)

2. **T+200ms**: 装饰性星星出现
   - 从小到大 scale: 0 → 1 (400ms, ease-out)
   - 星星闪烁动画启动(无限循环)

3. **T+400ms**: 核心答案登场
   - 从上方飘入: translateY(-100rpx) → 0 (600ms)
   - 同时旋转: rotate(10deg) → 0
   - 透明度: opacity: 0 → 1
   - 字体颜色渐变扫光效果

4. **T+1000ms**: 分隔线绘制
   - 从中心向两侧延伸(400ms)

5. **T+1200ms**: "书灵解读"按钮淡入
   - opacity: 0 → 1 (300ms)
   - 火花图标旋转动画

#### AI解读触发逻辑

##### 点击"书灵解读"按钮后:
1. **按钮状态变化**:
   - 图标从"▼"变为"loading"旋转动画
   - 文字变为"书灵思考中..."

2. **调用AI接口**:
   ```javascript
   wx.request({
     url: 'https://your-api.com/ai-analysis',
     method: 'POST',
     data: {
       category: result.category,
       answer: result.answer,
       userQuestion: userInput // 如果有输入框
     },
     success: (res) => {
       // 存储AI解读
       result.aiAnalysis = res.data.analysis;
       // 触发打字机效果
       this.typewriterEffect(res.data.analysis);
     }
   });
   ```

3. **打字机效果**:
   ```javascript
   typewriterEffect(text) {
     let index = 0;
     const timer = setInterval(() => {
       if (index < text.length) {
         this.setData({
           displayedText: text.substring(0, index + 1)
         });
         index++;
         // 每个字播放轻微音效(可选)
         if (index % 5 === 0) {
           wx.vibrateShort({ type: 'light' });
         }
       } else {
         clearInterval(timer);
         // 显示完成,按钮恢复为"收起"状态
       }
     }, 50); // 50ms/字
   }
   ```

---

## 三、异常情况处理

### 1. 长按过程中意外中断
**场景**: 用户长按时来电话/锁屏/切换应用

**处理**:
```javascript
// 在交互页onHide生命周期
onHide() {
  this.stopAllAnimations();
  bgAudio.stop();
  wx.showModal({
    title: '提示',
    content: '已中断,是否重新开始?',
    success: (res) => {
      if (res.confirm) {
        wx.navigateBack();
      }
    }
  });
}
```

### 2. 网络异常导致AI解读失败
**处理**:
- 显示预设的通用解读文案(本地fallback)
- 提示:"书灵暂时失联,请稍后再试"
- 提供"重新生成"按钮

### 3. 用户快速连续点击
**处理**:
- 设置全局防抖标志 `isProcessing`
- 前一次操作未完成时,后续点击无效

---

## 四、性能优化策略

### 1. 动画性能
- **书页翻动**: 使用 `transform` 和 `opacity`(触发GPU加速)
- **粒子特效**: Canvas限制在30fps,粒子数≤60个
- **避免使用**: `position`、`width`、`height` 等会触发重排的属性

### 2. 内存管理
- 离开交互页时销毁Canvas上下文
- 音频对象使用完毕后调用 `destroy()`
- 定时器及时清理

### 3. 首屏加载
- 首页图片使用webp格式,尺寸≤50KB
- 音效文件懒加载(首次长按时才加载)
- 字体采用系统默认,避免自定义字体加载延迟

---

## 五、技术实现要点总结

### 关键API
| 功能 | API | 参数 |
|-----|-----|------|
| 短震动 | `wx.vibrateShort()` | `{type: 'light'|'medium'|'heavy'}` |
| 长震动 | `wx.vibrateLong()` | `{duration: 400}` |
| 音频播放 | `wx.createInnerAudioContext()` | - |
| 页面跳转 | `wx.navigateTo()` / `wx.redirectTo()` | `{url: string}` |
| Canvas绘制 | `wx.createCanvasContext()` | `canvasId` |

### 关键数据流
```
用户输入(类别选择)
  → 触发长按
    → 启动动画+音效+震动
      → 持续2-5秒
        → 松开触发
          → 生成随机答案
            → 跳转结果页
              → 请求AI解读
                → 打字机展示
```

### 状态机图示
```
┌─────────┐  选择类别  ┌─────────┐  长按≥2s  ┌─────────┐
│  待机    │ ────────→ │  长按中  │ ────────→ │  生成中  │
└─────────┘           └─────────┘           └─────────┘
     ↑                      │                      │
     │                      │ 松开<2s              │
     │                      ↓                      ↓
     │                 ┌─────────┐           ┌─────────┐
     └─────────────────│  提示    │           │  展示    │
           再问一次      └─────────┘           └─────────┘
```

---

## 六、用户体验细节

### 时间节奏控制
- **首页 → 交互页**: 100ms(即时响应)
- **动画持续时间**: 2-5秒(用户可控)
- **交互页 → 结果页**: 500ms(包含过渡动画)
- **AI解读生成**: 2-5秒(服务端响应时间)
- **打字机展示**: 7-10秒(150字×50ms)

### 反馈完整性原则
每个用户操作必须包含:
1. **视觉反馈**(按钮状态变化)
2. **触觉反馈**(震动)
3. **听觉反馈**(音效,可选)

### 错误提示友好化
- ❌ "Error: Network timeout"
- ✅ "书灵暂时失联,请稍后再试 🙏"

---

> **设计哲学**: 通过精确的时间控制和多感官反馈,将"等待"本身转化为一种冥想体验,而非单纯的Loading时间。
