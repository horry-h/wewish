<!--pages/fortune/fortune.wxml-->
<view class="fortune-container">
  <!-- çŠ¶æ€æ å ä½ -->
  <view class="status-bar" style="height: {{statusBarHeight}}px;"></view>

  <!-- é¡¶éƒ¨è¿”å›æŒ‰é’® -->
  <view class="top-bar">
    <view class="back-btn" bindtap="onBack">
      <text class="icon">â†</text>
      <text>è¿”å›</text>
    </view>
  </view>

  <!-- æ ‡é¢˜åŒº -->
  <view class="title-section">
    <view class="main-title gradient-text" bindlongpress="onLongPressTitle">ä»Šæ—¥ä¸€ç­¾</view>
    <view class="subtitle">Daily Fortune</view>
  </view>

  <!-- ç­¾ç­’åŒºåŸŸ - é‡æ–°è®¾è®¡ä¸º"åŠ¨ç”»é£æ—¥å¼ç¥ç¤¾ç­¾ç­’" -->
  <view 
    class="shrine-section {{isInteracting ? 'interacting' : ''}}" 
    bindtouchstart="onTouchStart"
    bindtouchend="onTouchEnd"
    bindtouchcancel="onTouchEnd"
  >
    <!-- åŠ¨ç”»é£èƒŒæ™¯ï¼šæ¨±èŠ±ç²’å­ -->
    <view class="sakura-particles" wx:if="{{!showResult}}">
      <view class="sakura s1"></view>
      <view class="sakura s2"></view>
      <view class="sakura s3"></view>
      <view class="sakura s4"></view>
    </view>

    <!-- æ ¸å¿ƒç­¾ç­’ï¼šèµ›åšç¦…æ„ç»ç’ƒç­¾ç­’ -->
    <view class="omikuji-box {{isInteracting ? 'shaking' : ''}}">
      <!-- ç­¾ç­’å…‰æ™•èƒŒæ™¯ -->
      <view class="cyber-glow"></view>
      
      <!-- èµ›åšç­¾ç­’å›¾ç‰‡ -->
      <view class="cyber-bucket-wrapper">
        <image 
          class="cyber-bucket-image" 
          src="/assets/img/qiantong.jpg" 
          mode="widthFix"
        ></image>
      </view>

      <!-- æ‰è½ä¸­çš„é‚£æ ¹ç­¾ - é‡æ„ä¸º"èµ›åšç¦…æ„"é«˜è´¨æ„Ÿç­¾æ¡ -->
      <view class="divine-stick {{stickState}}" wx:if="{{stickState !== 'hidden'}}">
        <view class="stick-body">
          <view class="stick-shine"></view>
          <view class="stick-content">
            <text class="stick-text">å¾¡ç¥ç±¤</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ¨ç”»é£å¤©å…‰ï¼šå¸¦è™¹å½©æ„Ÿ -->
    <view class="celestial-beam {{stickState === 'dropping' ? 'active' : ''}}"></view>

    <!-- æç¤ºæ–‡å­—ï¼šèµ›åšç¦…æ„æ’ç‰ˆ -->
    <view class="anime-hint {{isInteracting ? 'active' : ''}}">
      <view class="hint-main-box">
        <text class="bracket">ã€Œ</text>
        <text class="hint-text-content cyber-zen-text">{{hintText}}</text>
        <text class="bracket">ã€</text>
      </view>
      <view class="hint-sub-box cyber-sub-hint" wx:if="{{!fortuneData || !hasClosedResult}}">
        <text>å¿ƒè¯šåˆ™çµï¼Œæ„Ÿå—å½“ä¸‹</text>
      </view>
    </view>

    <!-- é‡æ–°è®¾è®¡çš„å†å²å¤ç° -->
    <view class="anime-history" wx:if="{{fortuneData && !showResult && hasClosedResult}}" bindtap="showFortuneResult">
      <view class="revisit-tag">
        <view class="tag-icon">âœ¨</view>
        <text>æŸ¥çœ‹ä»Šæ—¥ç­¾æ–‡</text>
      </view>
    </view>
  </view>

  <!-- ç»“æœå¼¹çª— - æç®€è‰ºæœ¯çº¸ç­¾ -->
  <view class="result-modal {{showResult ? 'show' : ''}}" wx:if="{{fortuneData}}">
    <!-- çº¯å‡€æ·±è‰²èƒŒæ™¯ -->
    <view class="zen-backdrop" bindtap="onCloseResult"></view>

    <!-- è‰ºæœ¯çº¸ç­¾å®¹å™¨ -->
    <view class="lucky-card-wrapper" bindtap="onCloseResult">
      <view class="lucky-card {{showResult ? 'slide-up' : ''}}" catchtap="onPreventDefault">
        <!-- é¡¶éƒ¨æ„è±¡åŒº -->
        <view class="header-image-box" wx:if="{{backgroundImage}}">
          <image 
            src="{{backgroundImage}}" 
            class="header-image" 
            mode="aspectFill"
          ></image>
          <!-- å›¾ç‰‡ç¾½åŒ–æ¸å˜å±‚ -->
          <view class="image-feather-mask"></view>
        </view>

        <!-- è¿åŠ¿å°ç« ï¼ˆè·¨ç•Œæ”¾ç½®ï¼‰ -->
        <view class="soul-stamp {{fortuneData.level}}">
          <view class="stamp-border">
            <text class="stamp-text">{{fortuneData.levelText}}</text>
          </view>
        </view>

        <!-- çº¸ç­¾å†…å®¹åŒº -->
        <view class="paper-content">
          <!-- åˆ†äº«æ¨¡å¼é¡¶éƒ¨æç¤º -->
          <view class="shared-hint" wx:if="{{isSharedView}}">
            <view class="shared-icon">ğŸ</view>
            <view class="shared-text">è¿™æ˜¯å¥½å‹åˆ†äº«çš„ç­¾æ–‡</view>
          </view>

          <!-- å‚ç›´ç­¾æ–‡æ’ç‰ˆæ ¸å¿ƒ -->
          <view class="verse-section">
            <view class="verse-flow">
              <text class="verse-line" wx:for="{{verseLines}}" wx:key="*this">{{item}}</text>
            </view>
          </view>

          <!-- æç®€å®œ/å¿Œ -->
          <view class="lifestyle-advice">
            <view class="advice-row">
              <view class="dot green"></view>
              <text class="advice-label">å®œ</text>
              <text class="advice-val">{{fortuneData.suitable}}</text>
            </view>
            <view class="advice-row">
              <view class="dot red"></view>
              <text class="advice-label">å¿Œ</text>
              <text class="advice-val">{{fortuneData.unsuitable}}</text>
            </view>
          </view>

          <!-- ä¹¦çµå¯„è¯­ -->
          <view class="zen-message">
            <view class="message-guide">â—†</view>
            <view class="message-text">{{displayedMessage}}</view>
          </view>

          <!-- åº•éƒ¨æ“ä½œ -->
          <view class="card-footer">
            <!-- åˆ†äº«æ¨¡å¼ï¼šç‰¹æ®Šå¼•å¯¼æŒ‰é’® -->
            <view class="footer-primary-actions" wx:if="{{isSharedView}}">
              <view class="footer-btn primary try-mine" bindtap="onTryMyFortune">
                <text class="btn-icon">âœ¨</text>
                <text>æŠ½æˆ‘çš„ç­¾</text>
              </view>
              <view class="footer-btn secondary" bindtap="onCloseResult">è¿”å›é¦–é¡µ</view>
            </view>
            <!-- æ­£å¸¸æ¨¡å¼ï¼šä¿å­˜å’Œåˆ†äº« -->
            <view class="footer-primary-actions" wx:else>
              <view class="footer-btn primary" bindtap="onSaveFortune">ä¿å­˜çµç­¾</view>
              <button class="footer-btn primary" open-type="share" style="margin: 0; line-height: inherit; font-weight: 500;">åˆ†äº«ç¼˜åˆ†</button>
            </view>
            <view class="footer-btn close" bindtap="onCloseResult" wx:if="{{!isSharedView}}">æ”¶èµ·ç­¾æ–‡</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¦»å±Canvas -->
  <canvas 
    type="2d" 
    id="fortuneCanvas" 
    style="position: fixed; left: -9999px; top: -9999px; width: 375px; height: 667px;"
  ></canvas>
</view>
