# 每日一签 - 完整功能文档

## ✨ 已实现的三大增强功能

### 1. 🔊 摇签音效（通感增强）

**实现逻辑**:
- 检测到用户开始摇动 → 播放循环音效
- 摇动停止超过1秒 → 自动暂停音效
- 签条掉落时 → 停止音效

**代码位置**:
```typescript
// fortune.ts
- initShakeAudio()      // 初始化音效
- playShakeSound()      // 播放
- stopShakeSound()      // 停止
- handleAccelerometerChange() // 自动控制
```

**音效文件**: 
- 当前路径: `/assets/audio/page-flip.wav` (临时)
- 建议替换: `shake-fortune.wav` (真实摇签声)
- 详见: `AUDIO_README.md`

**用户体验**:
- ✅ 摇动时听到"哗啦哗啦"声，增强真实感
- ✅ 停止摇动时音效自动暂停，避免干扰
- ✅ 掉落瞬间停止，配合震动反馈

---

### 2. ⚡ AI 预调用（秒开体验）

**核心策略**:
```
用户摇动 2-3秒 = AI 接口请求耗时
结果：用户摇完 → 签文掉落 → AI恰好返回 → 秒开！
```

**实现细节**:
```typescript
// onShakeStart() 方法中
onShakeStart() {
  this.playShakeSound()
  this.generateFortune()  // 立即调用AI，不等待摇动完成
}
```

**时间线分析**:
```
T=0s    用户开始摇动
        ↓ 触发 onShakeStart()
        ↓ 开始请求AI接口
T=2-3s  用户摇够8次
        ↓ 触发签条掉落动画
T=3.5s  签条完全掉落
        ↓ 显示结果
        ✅ AI结果已就绪（提前完成）
```

**优势**:
- ✅ 用户无感知的等待时间
- ✅ 摇动过程掩盖网络延迟
- ✅ "秒开"的极致体验

---

### 3. 📅 每日限额（缘分已定）

**功能说明**:
- 每天只能抽一次签
- 再次进入自动展示历史签文
- 关闭后提示"明天再来"

**本地存储结构**:
```typescript
wx.setStorageSync('last_fortune_date', '2026-01-30')  // 日期标识
wx.setStorageSync('today_fortune', fortuneData)        // 签文内容
```

**业务流程**:

#### 首次抽签：
```
进入页面 
  → checkTodayFortune() 检查无历史记录
  → 显示"心怀虔诚，摇动手里的签筒"
  → 用户摇动
  → 生成签文
  → saveTodayFortune() 保存到本地
```

#### 再次进入：
```
进入页面
  → checkTodayFortune() 检测今日已抽签
  → 自动展示历史签文
  → 提示"今日缘分已定，这是您的签文"
  → 用户点击"点击查看"或等待800ms自动弹出
```

#### 尝试重复抽签：
```
点击关闭按钮
  → onCloseResult() 检测今日已抽签
  → 弹窗提示"每日只能抽取一次签文"
  → 返回上一页
```

**界面提示**:
- 金色脉动徽章："今日已抽"
- 点击查看按钮（带箭头动画）
- 自动弹出签文结果

**代码位置**:
```typescript
- getTodayDateKey()      // 获取日期标识 (YYYY-MM-DD)
- checkTodayFortune()    // 检查今日签文
- saveTodayFortune()     // 保存签文
- onCloseResult()        // 关闭时判断
```

---

## 🎯 完整用户流程

### 场景1：首次抽签
```
1. 点击首页🏮图标 → 进入摇签页
2. 看到提示："心怀虔诚，摇动手里的签筒"
3. 开始摇动手机
   - ✅ 听到摇签音效（循环播放）
   - ✅ 签筒晃动动画
   - ✅ 震动反馈
   - ✅ AI后台生成中
4. 摇够8次 → 音效停止 → 签条掉落
5. 1秒后签条完全掉落 → 翻转消失
6. 底部滑出签文卡片（秒开，无等待）
7. 打字机效果展示书灵寄语
```

### 场景2：当天二次进入
```
1. 点击首页🏮图标 → 进入摇签页
2. 看到提示："今日缘分已定，这是您的签文"
3. 看到金色徽章"今日已抽" + "点击查看"按钮
4. 点击或等待800ms → 自动展示历史签文
5. 点击关闭 → 提示"明天再来" → 返回首页
```

### 场景3：第二天使用
```
1. 进入摇签页 → 本地检测日期已过期
2. 清除历史记录 → 允许重新摇签
3. 重复场景1的流程
```

---

## 🔧 技术实现要点

### 性能优化
- ✅ `onUnload` 时停止加速度计
- ✅ 销毁音效实例释放内存
- ✅ 清理所有定时器

### 容错处理
- ✅ AI失败 → 使用默认签文
- ✅ 本地存储异常 → 允许重新抽签
- ✅ 音效加载失败 → 不影响核心功能

### 用户体验细节
- ✅ 摇动超过1秒无动作 → 音效自动暂停
- ✅ 加速度阈值 1.2 → 避免误触
- ✅ 防抖间隔 200ms → 流畅不卡顿
- ✅ 震动分级：light(摇动) / heavy(完成)

---

## 📁 文件清单

### 新增文件
- `pages/fortune/fortune.wxml` - 页面结构
- `pages/fortune/fortune.ts` - 业务逻辑
- `pages/fortune/fortune.wxss` - 样式
- `pages/fortune/fortune.json` - 配置
- `pages/fortune/AUDIO_README.md` - 音效说明

### 修改文件
- `pages/index/index.ts` - 添加跳转逻辑
- `app.json` - 注册新页面

---

## 🎨 待优化项

### 音效
- [ ] 替换为真实的摇签音效文件
- [ ] 根据摇动强度动态调整音量
- [ ] 添加签条掉落时的"咚"声

### 动画
- [ ] 签条掉落时添加木质碰撞声
- [ ] 增加签筒的细节装饰（木纹、雕花）
- [ ] 结果卡片展开时的粒子效果

### 功能
- [ ] 签文历史记录（查看过往抽签）
- [ ] 分享卡片时带上专属背景
- [ ] 运势统计（月度运势趋势）

---

## 💡 测试要点

### 功能测试
1. **首次抽签**：能否正常摇动、生成、展示
2. **二次进入**：能否正确识别今日已抽签
3. **跨天测试**：第二天能否重新抽签
4. **音效测试**：摇动时是否播放，停止是否暂停
5. **AI异常**：网络错误时是否使用默认签文
6. **存储异常**：清除缓存后是否正常工作

### 体验测试
1. **响应速度**：摇够次数后是否秒开结果
2. **音效同步**：音效是否与摇动同步
3. **动画流畅**：签条掉落是否流畅
4. **提示清晰**：各种状态提示是否易懂

---

## 🚀 部署注意事项

1. **加速度计权限**：需在 `app.json` 中声明
2. **音效文件大小**：建议 < 100KB，避免加载缓慢
3. **本地存储清理**：定期清理过期数据（可选）
4. **AI接口限流**：考虑添加请求频率限制

---

**最终效果**：
一个真实、流畅、有温度的日式摇签体验，融合视觉、触觉、听觉三重反馈，让用户感受到"这真的是在摇签筒"！🎋
