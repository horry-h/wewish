# 海报背景升级功能说明

## ✨ 功能概述

将原本的静态渐变背景升级为动态获取的Bing每日壁纸，让生成的海报卡片更加美观和富有变化。

---

## 🎯 核心特性

### 1. 动态背景获取
- **数据源**: 
  - Bing每日推荐壁纸 API（首次生成）
  - Bing历史随机壁纸 API（换背景功能）
- **请求地址**: 
  - 每日壁纸：`https://cn.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=zh-CN`
  - 随机壁纸：`https://bing.img.run/rand_m.php` (手机版1080P)
- **自动下载**: 使用 `wx.getImageInfo` 下载图片到本地临时路径
- **时间戳防缓存**: 随机壁纸URL添加时间戳，确保每次都获取不同的图片

### 2. Canvas 绘制层级

```
底层: Bing壁纸背景 (等比例填充铺满，居中裁剪)
  ↓
中层: 半透明黑色蒙层 rgba(0, 0, 0, 0.45)
  ↓
顶层: 白色文字内容 + 阴影效果
```

### 3. 视觉优化
- ✅ **内边距**: 40px 呼吸感边距
- ✅ **文字居中**: 核心答案和AI解读均采用居中对齐
- ✅ **阴影增强**: 答案文字添加黑色阴影，提升可读性
- ✅ **装饰线优化**: 更粗的分隔线 (2px)，透明度提升

### 4. 交互功能
- 🔄 **换背景按钮**: 点击随机获取Bing历史壁纸（每次都不一样）
- ⏳ **加载动画**: 刷新时按钮显示旋转动画
- 🛡️ **失败回退**: 网络失败时自动使用默认渐变背景
- 🎲 **真随机**: 添加时间戳参数，确保每次换背景都是新图片

---

## 📋 技术实现

### 核心函数

#### 1. `getBingDailyImage(useRandom)` - 获取Bing壁纸URL
```typescript
async getBingDailyImage(useRandom: boolean = false): Promise<string> {
  if (useRandom) {
    // 随机获取Bing历史壁纸（手机版1080P）
    const timestamp = Date.now()
    return `https://bing.img.run/rand_m.php?t=${timestamp}`
  } else {
    // 获取Bing每日壁纸
    const bingUrl = 'https://cn.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=zh-CN'
    // 返回完整图片URL
    return 'https://cn.bing.com' + res.data.images[0].url
  }
}
```

#### 2. `downloadImage(url)` - 下载图片到本地
```typescript
async downloadImage(url: string): Promise<string> {
  return new Promise((resolve, reject) => {
    wx.getImageInfo({
      src: url,
      success: (res) => resolve(res.path),
      fail: reject
    })
  })
}
```

#### 3. `drawPoster(forceRefreshBg, useRandomBg)` - 绘制海报
- **参数**: 
  - `forceRefreshBg` - 是否强制刷新背景
  - `useRandomBg` - 是否使用随机壁纸（默认false，使用每日壁纸）
- **流程**:
  1. 获取/下载背景图（根据useRandomBg选择API）
  2. 创建Canvas 2D上下文
  3. 绘制背景图 + 蒙层
  4. 绘制文字内容
  5. 导出临时图片路径

#### 4. `drawMultilineTextCentered()` - 居中多行文本
```typescript
drawMultilineTextCentered(ctx, text, centerX, y, maxWidth, lineHeight) {
  // 自动换行 + 居中对齐
}
```

---

## 🎨 UI 升级

### 海报预览弹窗布局

```
┌─────────────────────────────────────┐
│  长按保存图片    [🔄 换背景]  [✕]   │
├─────────────────────────────────────┤
│                                     │
│         [海报预览图]                │
│                                     │
├─────────────────────────────────────┤
│  [保存到相册]    [分享]             │
└─────────────────────────────────────┘
```

### 新增样式类
- `.poster-header-right` - 右侧按钮组容器
- `.poster-refresh-btn` - 换背景按钮
- `.refresh-icon` - 刷新图标 (带旋转动画)
- `.refresh-text` - "换背景"文字

---

## ⚙️ 配置要求

### 小程序后台配置

**必须操作**：将Bing域名添加到小程序白名单

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发 > 开发管理 > 开发设置 > 服务器域名**
3. 在 **downloadFile合法域名** 中添加：
   ```
   https://cn.bing.com
   https://bing.img.run
   ```

**域名说明**：
- `cn.bing.com` - 用于获取Bing每日壁纸（首次生成时使用）
- `bing.img.run` - 用于获取Bing历史随机壁纸（换背景功能使用）

### 开发调试配置

在微信开发者工具中调试时：
- 勾选 **详情 > 本地设置 > 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

---

## 🛡️ 错误处理

### 失败回退机制

```typescript
try {
  // 尝试获取Bing壁纸
  const bingUrl = await this.getBingDailyImage(useRandom)
  bgImagePath = await this.downloadImage(bingUrl)
} catch (error) {
  console.warn('获取Bing壁纸失败，使用默认渐变背景')
  // 自动回退到渐变背景
  this.drawGradientBackground(ctx)
}
```

### 常见错误场景

| 错误场景 | 处理方式 |
|---------|---------|
| 网络请求失败 | 回退到渐变背景 |
| 图片下载超时 | 回退到渐变背景 |
| Canvas加载失败 | 提示"生成失败" |
| 未配置域名白名单 | 回退到渐变背景 |
| 随机API失效 | 回退到渐变背景 |

---

## 📊 数据流程图

```
用户点击"生成卡片"
    ↓
首次生成 → 使用每日壁纸API
    ↓
下载图片 → 绘制海报 → 显示预览
    ↓
[用户点击"换背景"]
    ↓
使用随机壁纸API (带时间戳)
    ↓
下载新图片 → 重新绘制 → 更新预览
    ↓ (失败)
回退到渐变背景
    ↓
导出临时图片
    ↓
显示预览弹窗
    ↓
[用户点击"换背景"] → 强制刷新 → 重新绘制
```

---

## 🎯 用户体验优化

### 1. 首次生成
- ✅ 自动获取当天Bing壁纸
- ✅ 显示"书灵正在绘图..."加载提示
- ✅ 失败时无感切换到渐变背景

### 2. 换背景
- ✅ 按钮显示旋转动画
- ✅ 震动反馈增强操作感
- ✅ 成功后提示"背景已更换"

### 3. 性能优化
- ✅ 图片URL缓存，避免重复请求
- ✅ Canvas离屏渲染，不影响页面性能
- ✅ 异步加载图片，不阻塞主线程

---

## 📝 代码位置

### 修改的文件

1. **home.ts** (主要逻辑)
   - 新增 `getBingDailyImage()` 方法
   - 新增 `downloadImage()` 方法
   - 新增 `onRefreshBackground()` 方法
   - 升级 `drawPoster()` 方法
   - 新增 `drawMultilineTextCentered()` 方法
   - 新增 `drawGradientBackground()` 方法

2. **home.wxml** (UI结构)
   - 修改 `.poster-header` 布局
   - 新增"换背景"按钮

3. **home.less** (样式)
   - 新增 `.poster-header-right` 样式
   - 新增 `.poster-refresh-btn` 样式
   - 新增 `@keyframes rotate360` 动画

4. **README.md** (文档)
   - 新增"配置要求"章节

---

## 🚀 后续优化建议

### 功能扩展
- [ ] 支持用户上传自定义背景
- [ ] 增加背景图库（多套预设风格）
- [ ] 添加滤镜效果（复古、冷色调等）
- [ ] 保存用户偏好的背景设置

### 性能优化
- [ ] 背景图片本地持久化缓存
- [ ] 预加载下一张壁纸
- [ ] WebP格式支持（减小图片体积）
- [ ] CDN加速（自建图床）

### 视觉优化
- [ ] 更多文字排版样式
- [ ] 动态字体大小（根据文字长度）
- [ ] 渐变蒙层（从上到下透明度渐变）
- [ ] 边框装饰（古典书籍风格）

---

## 📞 技术支持

如遇问题，请检查：
1. ✅ 是否配置了域名白名单
2. ✅ 网络是否正常
3. ✅ 小程序是否有 `downloadFile` 权限
4. ✅ Canvas 2D 是否初始化成功

**开发者工具调试**：
- 打开 Console 查看错误日志
- 检查 Network 面板的请求状态
- 使用真机调试验证域名配置

---

**版本**: v2.0.0  
**更新日期**: 2026-01-29  
**作者**: AI Assistant
