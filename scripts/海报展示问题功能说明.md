# 海报展示问题功能说明

## 功能概述

在生成海报时，用户可以选择是否在海报上展示他们提出的问题。通过一个优雅的开关组件，用户可以实时切换并预览效果。

## 功能特性

✅ **可选展示** - 用户可自由选择是否展示问题  
✅ **实时预览** - 切换开关后自动重绘海报  
✅ **动态布局** - 问题展示时自动调整其他元素位置  
✅ **自动换行** - 长问题自动换行，不会超出画布  
✅ **治愈风格** - 开关样式符合整体设计美学  

## 实现细节

### 1. 数据结构

```typescript
data: {
  showQuestion: true, // 默认展示问题
  userThought: '',    // 用户的问题内容
  // ...其他数据
}
```

### 2. UI 组件（WXML）

```xml
<!-- 展示问题开关 (仅在有问题时显示) -->
<view class="poster-option" wx:if="{{userThought}}">
  <view class="poster-option-label">
    <text class="option-icon">💭</text>
    <text>展示我的问题</text>
  </view>
  <switch 
    class="poster-switch" 
    checked="{{showQuestion}}" 
    bindchange="onToggleShowQuestion"
    color="#ffffff"
  />
</view>
```

### 3. 交互逻辑（JS）

```typescript
// 切换开关事件
onToggleShowQuestion(e: any) {
  const showQuestion = e.detail.value
  this.setData({ showQuestion })
  
  // 立即重新绘制，实时预览
  wx.vibrateShort({ type: 'light' })
  this.drawPoster(false, false) // 不刷新背景
}
```

### 4. Canvas 动态布局

#### 布局策略
```typescript
// 1. 固定部分：分类图标和名称
let currentY = 220 + padding

// 2. 可选部分：用户问题
if (showQuestion && userThought) {
  // 绘制问题
  const questionText = `" ${userThought} "`
  const lines = this.wrapText(ctx, questionText, 650)
  
  lines.forEach((line, index) => {
    ctx.fillText(line, 375, currentY + index * 40)
  })
  
  // 更新Y轴位置
  questionHeight = lines.length * 40 + 40
  currentY += questionHeight
}

// 3. 核心答案（根据currentY动态定位）
ctx.fillText(answer, 375, currentY + 80)

// 4. 后续元素自动下移
currentY += answerHeight + 60
```

#### 视觉样式
- **字体大小**: 28px（比答案稍小）
- **颜色**: `rgba(255, 255, 255, 0.8)`（透明度0.8）
- **格式**: `" 问题内容 "`（双引号包裹）
- **对齐**: 居中对齐
- **行高**: 40px

### 5. 文本换行算法

```typescript
wrapText(ctx: any, text: string, maxWidth: number): string[] {
  const lines: string[] = []
  let currentLine = ''

  for (let i = 0; i < text.length; i++) {
    const char = text[i]
    const testLine = currentLine + char
    const metrics = ctx.measureText(testLine)

    if (metrics.width > maxWidth && currentLine) {
      lines.push(currentLine)
      currentLine = char
    } else {
      currentLine = testLine
    }
  }
  
  if (currentLine) {
    lines.push(currentLine)
  }

  return lines
}
```

## 样式设计

### 开关容器
```less
.poster-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 24rpx;
  padding: 20rpx 24rpx;
  background: rgba(255, 255, 255, 0.08);
  border-radius: 16rpx;
  backdrop-filter: blur(10rpx);
}
```

### 标签样式
```less
.poster-option-label {
  display: flex;
  align-items: center;
  gap: 12rpx;
  font-size: 26rpx;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}
```

### Switch 自定义
```less
.poster-switch[checked]::after {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
```

## 用户体验优化

### 1. 条件显示
- 只有当用户输入了问题时，才显示开关
- 没有问题时，自动隐藏开关

### 2. 实时反馈
- 切换开关时有轻微震动反馈
- 立即重绘海报，无需点击按钮
- 保持当前背景图，避免闪烁

### 3. 默认行为
- 默认展示问题（`showQuestion: true`）
- 用户可以关闭展示以保护隐私

### 4. 布局自适应
- 问题长短不一，自动计算高度
- 后续元素根据问题高度动态下移
- 确保所有内容都在画布内

## 技术亮点

### 1. 动态Y轴计算
```typescript
let currentY = 220 + padding

// 问题区域
if (showQuestion && userThought) {
  // ... 绘制问题
  currentY += questionHeight
}

// 答案区域（基于更新后的 currentY）
const answerStartY = currentY + 80
```

### 2. 高度预测
```typescript
// 先获取行数，计算高度
const lines = this.wrapText(ctx, questionText, 650)
const questionHeight = lines.length * 40 + 40

// 再根据高度调整后续元素
currentY += questionHeight
```

### 3. 缓存优化
```typescript
// 切换开关时不刷新背景
this.drawPoster(false, false)
// 参数1: forceRefreshBg = false（不刷新）
// 参数2: useRandomBg = false（使用当前背景）
```

## 效果展示

### 开启展示问题
```
━━━━━━━━━━━━━━━━━━━━━━━
     ✨
  此时此刻
  
" 我该如何面对内心的焦虑 "

「 累了就停下 」

────────────

红了樱桃、绿了芭蕉
时间会告诉我们一切

记录于 2026-01-29 23:30
━━━━━━━━━━━━━━━━━━━━━━━
```

### 关闭展示问题
```
━━━━━━━━━━━━━━━━━━━━━━━
     ✨
  此时此刻

「 累了就停下 」

────────────

红了樱桃、绿了芭蕉
时间会告诉我们一切

记录于 2026-01-29 23:30
━━━━━━━━━━━━━━━━━━━━━━━
```

## 使用流程

1. 用户输入问题并获得答案
2. 点击"生成卡片"按钮
3. 在海报预览弹窗中看到开关选项
4. 切换开关，实时预览效果
5. 满意后保存或分享

## 注意事项

1. **性能**: 切换时会重绘Canvas，但因为使用了缓存背景，速度很快
2. **隐私**: 默认展示问题，但用户可随时关闭
3. **布局**: 长问题会自动换行，不会超出画布
4. **兼容性**: 使用原生 Switch 组件，兼容性好

## 后续优化建议

1. **字体样式**: 可以考虑使用斜体或特殊字体来区分问题
2. **背景高亮**: 在问题文字下方添加淡淡的高光效果
3. **动画**: 切换开关时可以添加淡入淡出动画
4. **记忆功能**: 记住用户的选择偏好

## 文件变更

- `index.ts` - 添加 `showQuestion` 字段和 `onToggleShowQuestion` 方法
- `index.ts` - 更新 `drawPoster` 函数，添加动态布局逻辑
- `index.ts` - 新增 `wrapText` 辅助函数
- `index.wxml` - 添加开关组件
- `index.less` - 添加开关样式
