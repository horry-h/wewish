# AI解读功能部署说明

## 概述
"书灵解读"功能已集成腾讯混元大模型API，当用户点击展开解读时，会调用真实的AI生成个性化的治愈系解读。

## 技术架构

### 云函数方式（推荐）
```
小程序 → 云函数(generateAnalysis) → 混元API → 返回解读
```

**优点：**
- 安全：API Key不暴露在小程序端
- 稳定：云函数自动扩容
- 免域名配置：无需添加服务器域名

## 部署步骤

### 1. 开通微信云开发
1. 在微信开发者工具中点击"云开发"
2. 创建云环境（按量计费或套餐版）
3. 记录云环境ID（如：cloud1-xxx）

### 2. 配置云环境ID
修改 `/program/miniprogram/pages/home/home.ts` 第333行：
```typescript
wx.cloud.init({
  env: 'your-env-id' // 替换为你的云环境ID
})
```

### 3. 初始化云开发SDK
在 `/program/miniprogram/app.ts` 中初始化：
```typescript
App({
  onLaunch() {
    // 初始化云开发
    wx.cloud.init({
      env: 'your-env-id', // 替换为你的云环境ID
      traceUser: true
    })
  }
})
```

### 4. 上传云函数
1. 右键点击 `server/generateAnalysis` 目录
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 5. 配置API Key（可选）
当前API Key已内置在云函数中：
```
sk-h7vMtZVg5ZD6wGqIOIYb9TiFOSZNuBgQk9JjetcaMewlUix8
```

如需更换，修改 `/server/generateAnalysis/index.js` 第9行。

### 6. 测试功能
1. 在小程序中长按寻声获取答案
2. 点击"书灵解读"展开
3. 观察是否正常生成AI解读

## API说明

### 混元API配置
- **接口**: https://api.hunyuan.cloud.tencent.com/v1/chat/completions
- **模型**: hunyuan-turbos-latest
- **参数**:
  - temperature: 0.8（创造性）
  - top_p: 0.9（多样性）
  - enable_enhancement: true（增强效果）

### 提示词策略

#### 系统提示词
定义"书灵"的人设和风格：
- 温柔、治愈、充满智慧
- 诗意、柔和、共情
- 神秘而庄重

#### 用户提示词
包含以下信息：
- 问题分类（情感/事业/学业等）
- 抽到的答案
- 用户心声（如果填写）

#### 回答格式
```
亲爱的朋友，

[正文段落1]

[正文段落2]

愿你...[祝福语]

—— 书灵 🌙
```

## 兜底机制

### 本地兜底
当云函数调用失败时，自动使用本地预设的解读模板（`getMockAnalysis`方法）。

### 云端兜底
当混元API调用失败时，云函数返回通用的治愈性解读。

## 成本估算

### 云函数费用
- 免费额度：每月1000次调用
- 超出费用：约 0.00011 元/次

### 混元API费用
- hunyuan-turbos-latest：约 0.004元/千tokens
- 预估单次解读：~500 tokens = 0.002元
- 1000次解读：约 2元

**总成本：** 1000次/月约2元

## 监控与优化

### 云函数日志
在云开发控制台查看调用日志：
1. 打开云开发控制台
2. 进入"云函数"
3. 点击"日志"查看调用情况

### 优化建议
1. **缓存机制**：相同答案+分类可缓存
2. **限流保护**：单用户每分钟限制3次
3. **降级策略**：AI不可用时自动使用本地模板

## 故障排查

### 1. 云函数调用失败
**错误**: `errCode: -1`
**解决**: 
- 检查云环境ID是否正确
- 确认云函数已上传并部署成功
- 查看云函数日志

### 2. API调用失败
**错误**: `API返回格式异常`
**解决**:
- 检查API Key是否有效
- 确认网络连接正常
- 查看云函数中的error日志

### 3. 解读内容不符合预期
**解决**:
- 调整temperature参数（降低=更稳定）
- 优化系统提示词
- 修改用户提示词格式

## 安全建议

1. **API Key保护**
   - ✅ 存储在云函数中（已实现）
   - ❌ 不要暴露在小程序代码中
   
2. **访问控制**
   - 添加用户频率限制
   - 记录调用日志
   
3. **内容审核**
   - 混元API自带内容安全检测
   - 可添加额外的敏感词过滤

## 文件清单

```
/server/generateAnalysis/
├── index.js          # 云函数主逻辑
├── package.json      # 依赖配置
└── config.json       # 权限配置

/program/miniprogram/pages/home/
└── home.ts           # 调用云函数的客户端代码

/scripts/
├── env               # API Key配置（不要提交到git）
└── AI集成说明.md     # 本文档
```

## 后续优化方向

1. **流式响应**：实现打字机效果的同时流式接收AI响应
2. **多轮对话**：支持用户追问
3. **个性化**：基于用户历史记录优化解读
4. **语音播报**：将解读文本转为语音
5. **分享功能**：生成精美的解读卡片图片

---

部署完成后，用户点击"书灵解读"即可获得由AI生成的个性化、治愈系的答案解读！✨🌙
