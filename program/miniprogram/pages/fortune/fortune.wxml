<!--pages/fortune/fortune.wxml-->
<view class="fortune-container">
  <!-- 状态栏占位 -->
  <view class="status-bar" style="height: {{statusBarHeight}}px;"></view>

  <!-- 顶部返回按钮 -->
  <view class="top-bar">
    <view class="back-btn" bindtap="onBack">
      <text class="icon">←</text>
      <text>返回</text>
    </view>
  </view>

  <!-- 标题区 -->
  <view class="title-section">
    <view class="main-title gradient-text" bindlongpress="onLongPressTitle">今日一签</view>
    <view class="subtitle">Daily Fortune</view>
  </view>

  <!-- 签筒区域 - 重新设计为“动画风日式神社签筒” -->
  <view 
    class="shrine-section {{isInteracting ? 'interacting' : ''}}" 
    bindtouchstart="onTouchStart"
    bindtouchend="onTouchEnd"
    bindtouchcancel="onTouchEnd"
  >
    <!-- 动画风背景：樱花粒子 -->
    <view class="sakura-particles" wx:if="{{!showResult}}">
      <view class="sakura s1"></view>
      <view class="sakura s2"></view>
      <view class="sakura s3"></view>
      <view class="sakura s4"></view>
    </view>

    <!-- 核心签筒：萌系猪猪样式 -->
    <view class="omikuji-box {{isInteracting ? 'shaking' : ''}}">
      <!-- 签筒阴影 -->
      <view class="bucket-glow"></view>
      
      <!-- 猪猪签筒主体 -->
      <view class="piggy-bucket">
        <!-- 猪耳朵 -->
        <view class="pig-ear left"></view>
        <view class="pig-ear right"></view>
        
        <!-- 筒身 -->
        <view class="bucket-body">
          <view class="gold-rim-top"></view>
          
          <!-- 猪脸 -->
          <view class="pig-face">
            <view class="pig-eye left">
              <view class="eye-sparkle"></view>
            </view>
            <view class="pig-eye right">
              <view class="eye-sparkle"></view>
            </view>
            <view class="pig-nose">
              <view class="nostril"></view>
              <view class="nostril"></view>
            </view>
          </view>
          
          <!-- 签字标签 -->
          <view class="tag-diamond">
            <text>签</text>
          </view>
        </view>

        <!-- 内部签束：扁平化宽签 -->
        <view class="anime-sticks">
          <view class="a-stick s1"><text>好运上上</text></view>
          <view class="a-stick s2"><text>财运上上</text></view>
          <view class="a-stick s3"><text>缘分上上</text></view>
          <view class="a-stick s4"><text>事业大吉</text></view>
          <view class="a-stick s5"><text>平安顺遂</text></view>
        </view>
      </view>

      <!-- 掉落中的那根签 -->
      <view class="divine-stick {{stickState}}" wx:if="{{stickState !== 'hidden'}}">
        <view class="legendary-glow"></view>
        <view class="stick-paper flat-stick">
          <view class="stick-head"></view>
          <view class="paper-text">御神籤</view>
        </view>
      </view>
    </view>

    <!-- 动画风天光：带虹彩感 -->
    <view class="celestial-beam {{stickState === 'dropping' ? 'active' : ''}}"></view>

    <!-- 提示文字：日系排版 -->
    <view class="anime-hint {{isInteracting ? 'active' : ''}}">
      <view class="hint-main-box">
        <text class="bracket">「</text>
        <text class="hint-text-content">{{hintText}}</text>
        <text class="bracket">」</text>
      </view>
      <view class="hint-sub-box" wx:if="{{!fortuneData || !hasClosedResult}}">
        <text>静心摇动</text>
        <view class="pulse-dot"></view>
        <text>缘分自现</text>
      </view>
    </view>

    <!-- 重新设计的历史复现 -->
    <view class="anime-history" wx:if="{{fortuneData && !showResult && hasClosedResult}}" bindtap="showFortuneResult">
      <view class="revisit-tag">
        <view class="tag-icon">✨</view>
        <text>查看今日签文</text>
      </view>
    </view>
  </view>

  <!-- 结果弹窗 - 极简艺术纸签 -->
  <view class="result-modal {{showResult ? 'show' : ''}}" wx:if="{{fortuneData}}">
    <!-- 纯净深色背景 -->
    <view class="zen-backdrop" bindtap="onCloseResult"></view>

    <!-- 艺术纸签容器 -->
    <view class="lucky-card-wrapper" bindtap="onCloseResult">
      <view class="lucky-card {{showResult ? 'slide-up' : ''}}" catchtap="onPreventDefault">
        <!-- 顶部意象区 -->
        <view class="header-image-box" wx:if="{{backgroundImage}}">
          <image 
            src="{{backgroundImage}}" 
            class="header-image" 
            mode="aspectFill"
          ></image>
          <!-- 图片羽化渐变层 -->
          <view class="image-feather-mask"></view>
        </view>

        <!-- 运势印章（跨界放置） -->
        <view class="soul-stamp {{fortuneData.level}}">
          <view class="stamp-border">
            <text class="stamp-text">{{fortuneData.levelText}}</text>
          </view>
        </view>

        <!-- 纸签内容区 -->
        <view class="paper-content">
          <!-- 垂直签文排版核心 -->
          <view class="verse-section">
            <view class="verse-flow">
              <text class="verse-line" wx:for="{{verseLines}}" wx:key="*this">{{item}}</text>
            </view>
          </view>

          <!-- 极简宜/忌 -->
          <view class="lifestyle-advice">
            <view class="advice-row">
              <view class="dot green"></view>
              <text class="advice-label">宜</text>
              <text class="advice-val">{{fortuneData.suitable}}</text>
            </view>
            <view class="advice-row">
              <view class="dot red"></view>
              <text class="advice-label">忌</text>
              <text class="advice-val">{{fortuneData.unsuitable}}</text>
            </view>
          </view>

          <!-- 书灵寄语 -->
          <view class="zen-message">
            <view class="message-guide">◆</view>
            <view class="message-text">{{displayedMessage}}</view>
          </view>

          <!-- 底部操作 -->
          <view class="card-footer">
            <view class="footer-primary-actions">
              <view class="footer-btn primary" bindtap="onSaveFortune">保存灵签</view>
              <button class="footer-btn primary" open-type="share" style="margin: 0; line-height: inherit; font-weight: 500;">分享缘分</button>
            </view>
            <view class="footer-btn close" bindtap="onCloseResult">收起签文</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 离屏Canvas -->
  <canvas 
    type="2d" 
    id="fortuneCanvas" 
    style="position: fixed; left: -9999px; top: -9999px; width: 375px; height: 667px;"
  ></canvas>
</view>
